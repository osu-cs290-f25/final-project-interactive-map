---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Elden Ring Explorer">
  <main>
    <!-- Header -->
    <header class="hero">
      <h1 class="hero-title">ELDEN RING</h1>
      <div class="hero-divider"></div>
      <p class="hero-subtitle">The Lands Between</p>
    </header>

    <!-- Drawing Controls -->
    <div class="drawing-controls">
      <button id="draw-gold" class="draw-btn active" data-color="#c19d53"
        >Gold Path</button
      >
      <button id="draw-red" class="draw-btn" data-color="#ff4444"
        >Red Path</button
      >
      <button id="draw-blue" class="draw-btn" data-color="#4444ff"
        >Blue Path</button
      >
      <button id="draw-green" class="draw-btn" data-color="#44ff44"
        >Green Path</button
      >
      <button id="draw-purple" class="draw-btn" data-color="#ff44ff"
        >Purple Path</button
      >
      <button id="clear-all" class="clear-btn">Clear All</button>
    </div>

    <!-- Map Container -->
    <section class="map-section">
      <div id="map"></div>
    </section>
  </main>
</Layout>

<style>
  main {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* Header Styles */
  .hero {
    padding: 3rem 2rem 2rem;
    text-align: center;
    background: linear-gradient(
      180deg,
      var(--black) 0%,
      var(--black-light) 100%
    );
    border-bottom: 2px solid var(--bronze);
    position: relative;
  }

  .hero::after {
    content: "";
    position: absolute;
    bottom: -1px;
    left: 50%;
    transform: translateX(-50%);
    width: 60%;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--gold), transparent);
  }

  .hero-title {
    font-size: clamp(2.5rem, 8vw, 5rem);
    color: var(--gold);
    text-shadow:
      0 0 20px rgba(193, 157, 83, 0.3),
      0 4px 8px rgba(0, 0, 0, 0.8);
    margin-bottom: 1rem;
    letter-spacing: 0.15em;
  }

  .hero-divider {
    width: 200px;
    height: 2px;
    background: var(--gold);
    margin: 1rem auto;
    position: relative;
  }

  .hero-divider::before,
  .hero-divider::after {
    content: "";
    position: absolute;
    width: 8px;
    height: 8px;
    background: var(--gold);
    border-radius: 50%;
    top: 50%;
    transform: translateY(-50%);
  }

  .hero-divider::before {
    left: -12px;
  }
  .hero-divider::after {
    right: -12px;
  }

  .hero-subtitle {
    font-size: clamp(0.9rem, 2vw, 1.2rem);
    color: var(--bronze);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    font-weight: 500;
  }

  /* Drawing Controls */
  .drawing-controls {
    display: flex;
    gap: 0.5rem;
    padding: 1rem;
    background: var(--black-light);
    border-bottom: 1px solid var(--bronze);
    flex-wrap: wrap;
    justify-content: center;
  }

  .draw-btn,
  .clear-btn {
    padding: 0.5rem 1rem;
    font-family: var(--font-display);
    font-size: 0.85rem;
    letter-spacing: 0.05em;
    border: 1px solid var(--bronze);
    background: var(--black);
    color: var(--gold);
    cursor: pointer;
    transition: all 0.2s;
  }

  .draw-btn:hover,
  .clear-btn:hover {
    background: var(--bronze);
    color: var(--black);
    box-shadow: 0 0 10px rgba(193, 157, 83, 0.3);
  }

  .draw-btn.active {
    background: var(--gold);
    color: var(--black);
    box-shadow: 0 0 15px rgba(193, 157, 83, 0.5);
    font-weight: bold;
  }

  .clear-btn {
    background: #5a3a2a;
    border-color: #8b7355;
  }

  .clear-btn:hover {
    background: #8b4545;
  }

  /* Map Section */
  .map-section {
    flex: 1;
    position: relative;
    min-height: 70vh;
  }

  #map {
    width: 100%;
    height: 100%;
    min-height: 70vh;
    background: var(--black-light);
    border-top: 1px solid var(--brown);
  }

  /* Leaflet Draw Toolbar Styling */
  :global(.leaflet-draw-toolbar) {
    display: none !important;
  }

  :global(.leaflet-draw-actions) {
    background: var(--black-light);
    border: 1px solid var(--bronze);
  }

  :global(.leaflet-draw-actions a) {
    background: var(--black);
    color: var(--gold);
    border-right: 1px solid var(--bronze);
  }

  :global(.leaflet-draw-actions a:hover) {
    background: var(--bronze);
  }

  /* Leaflet Override Styles */
  :global(.leaflet-container) {
    background: var(--black-light);
    font-family: var(--font-body);
  }
  /* Marker styles */
  :global(.custom-marker) {
    background: none !important;
    border: none !important;
  }

  :global(.marker-x) {
    font-size: 24px;
    color: #c19d53;
    text-shadow:
      0 0 10px rgba(193, 157, 83, 0.8),
      0 0 20px rgba(193, 157, 83, 0.5);
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 30px;
    height: 30px;
  }

  :global(.marker-popup) {
    padding: 0.5rem;
    min-width: 150px;
  }

  :global(.marker-popup p) {
    margin: 0 0 0.5rem 0;
    color: #c19d53;
  }

  :global(.delete-marker-btn) {
    background: #8b7355;
    color: #0d0c0b;
    border: 1px solid #c19d53;
    padding: 0.25rem 0.75rem;
    cursor: pointer;
    font-family: var(--font-display);
    font-size: 0.75rem;
    letter-spacing: 0.05em;
    transition: all 0.2s;
  }

  :global(.delete-marker-btn:hover) {
    background: #c19d53;
    box-shadow: 0 0 10px rgba(193, 157, 83, 0.5);
  }
  /* Responsive */
  @media (max-width: 768px) {
    .hero {
      padding: 2rem 1rem 1.5rem;
    }

    .hero-title {
      font-size: 2rem;
    }

    #map {
      min-height: 60vh;
    }

    .drawing-controls {
      padding: 0.5rem;
    }

    .draw-btn,
    .clear-btn {
      padding: 0.4rem 0.8rem;
      font-size: 0.75rem;
    }
  }
</style>

<script>
  import L from "leaflet";
  import "leaflet-draw";
  import "leaflet-draw/dist/leaflet.draw.css";

  // Define the image bounds
  const imageBounds: L.LatLngBoundsExpression = [
    [0, 0],
    [1000, 1000],
  ];

  // Initialize map with CRS.Simple
  const map = L.map("map", {
    crs: L.CRS.Simple,
    minZoom: -2,
    maxZoom: 2,
    zoomSnap: 0.25,
    zoomDelta: 0.5,
  });

  // Add the Elden Ring map image
  const imageUrl = "/EldenRingMap.jpg";
  L.imageOverlay(imageUrl, imageBounds).addTo(map);

  // Fit the map to the image bounds
  map.fitBounds(imageBounds);

  // Layer to store all drawings
  const drawnItems = new L.FeatureGroup();
  map.addLayer(drawnItems);

  // Current drawing color
  let currentColor = "#c19d53";

  // Initialize Leaflet.draw control (hidden - we use custom buttons)
  const drawControl = new L.Control.Draw({
    draw: {
      polyline: {
        shapeOptions: {
          color: currentColor,
          weight: 4,
          opacity: 0.8,
        },
        showLength: false,
      },
      polygon: false,
      rectangle: false,
      circle: false,
      marker: false,
      circlemarker: false,
    },
    edit: {
      featureGroup: drawnItems,
      remove: true,
      edit: false,
    },
  });

  map.addControl(drawControl);

  // Handle drawing created
  map.on(L.Draw.Event.CREATED, (event: any) => {
    const layer = event.layer;
    drawnItems.addLayer(layer);
    saveDrawings();
  });

  // Handle drawing deleted
  map.on(L.Draw.Event.DELETED, () => {
    saveDrawings();
  });

  // Color button handlers - trigger polyline draw mode
  const drawButtons = document.querySelectorAll(".draw-btn");
  drawButtons.forEach((btn) => {
    btn.addEventListener("click", (e) => {
      const target = e.currentTarget as HTMLElement;
      const color = target.dataset.color || "#c19d53";

      currentColor = color;

      // Update active state
      drawButtons.forEach((b) => b.classList.remove("active"));
      target.classList.add("active");

      // Start drawing with new color
      new (L.Draw as any).Polyline(map, {
        shapeOptions: {
          color: currentColor,
          weight: 4,
          opacity: 0.8,
        },
        showLength: false,
      }).enable();
    });
  });

  // Clear all button
  document.getElementById("clear-all")?.addEventListener("click", () => {
    if (confirm("Clear all drawings?")) {
      drawnItems.clearLayers();
      saveDrawings();
    }
  });

  // Save to localStorage
  function saveDrawings() {
    const drawings: any[] = [];

    drawnItems.eachLayer((layer: any) => {
      if (layer instanceof L.Polyline) {
        drawings.push({
          type: "polyline",
          latlngs: layer.getLatLngs(),
          color: layer.options.color,
          weight: layer.options.weight,
        });
      }
    });

    localStorage.setItem("eldenDrawings", JSON.stringify(drawings));
  }

  // Marker functionality (from earth.astro, without glow)
  const xIcon = L.divIcon({
    className: "custom-marker",
    html: '<div class="marker-x">âœ•</div>',
    iconSize: [30, 30],
    iconAnchor: [15, 15],
  });

  let markers: Array<{ lat: number; lng: number; text: string }> = [];

  // Load markers from localStorage
  function loadMarkers() {
    const saved = localStorage.getItem("eldenMarkers");
    return saved ? JSON.parse(saved) : [];
  }

  // Save markers to localStorage
  function saveMarkers(
    markers: Array<{ lat: number; lng: number; text: string }>,
  ) {
    localStorage.setItem("eldenMarkers", JSON.stringify(markers));
  }

  // Create marker
  function createMarker(lat: number, lng: number, text: string) {
    const marker = L.marker([lat, lng], { icon: xIcon }).addTo(map);

    const popupContent = `
      <div class="marker-popup">
        <p>${text || "<em>No notes</em>"}</p>
        <button class="delete-marker-btn" data-lat="${lat}" data-lng="${lng}">Delete</button>
      </div>
    `;
    marker.bindPopup(popupContent);
  }

  // Initialize markers
  markers = loadMarkers();
  markers.forEach((data) => {
    createMarker(data.lat, data.lng, data.text);
  });

  // Add marker on shift+click (avoid conflict with drawing)
  map.on("click", (e: L.LeafletMouseEvent) => {
    if (e.originalEvent.shiftKey) {
      const text = prompt("Add a note for this location:");
      if (text !== null && text.trim() !== "") {
        const { lat, lng } = e.latlng;
        markers.push({ lat, lng, text });
        saveMarkers(markers);
        createMarker(lat, lng, text);
      }
    }
  });

  // Delete marker handler (delegated event)
  map.on("popupopen", (e: L.PopupEvent) => {
    const popup = e.popup;
    const deleteBtn = popup
      .getElement()
      ?.querySelector(".delete-marker-btn") as HTMLElement;

    if (deleteBtn) {
      deleteBtn.addEventListener("click", () => {
        const lat = parseFloat(deleteBtn.dataset.lat || "0");
        const lng = parseFloat(deleteBtn.dataset.lng || "0");

        markers = markers.filter((m) => m.lat !== lat || m.lng !== lng);
        saveMarkers(markers);
        location.reload();
      });
    }
  });

  // Load existing drawings on page load
  loadDrawings();
  // Load from localStorage
  function loadDrawings() {
    const saved = localStorage.getItem("eldenDrawings");
    if (!saved) return;

    try {
      const drawings = JSON.parse(saved);

      drawings.forEach((drawing: any) => {
        if (drawing.type === "polyline") {
          const polyline = L.polyline(drawing.latlngs, {
            color: drawing.color,
            weight: drawing.weight || 4,
            opacity: 0.8,
          });
          drawnItems.addLayer(polyline);
        }
      });
    } catch (e) {
      console.error("Failed to load drawings:", e);
    }
  }

  // Load existing drawings on page load
  loadDrawings();
</script>
